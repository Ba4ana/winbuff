## Быстрые инструкции для AI-агента — репозиторий `winbuff`

Ниже — сжатые, практичные указания для внесения изменений в этот репозиторий. Сосредоточьтесь на конкретных файлах и паттернах — избегайте общих советов.

- Главные файлы: `winbuff.py` (Python, Windows-ориентированная логика), `_winbuff.ps1` (PowerShell — основной установщик/конфигуратор для Windows), `winbuff.sh` (Debian/Unix-ветка), `readme.md`, `license.md`.

- Что делает проект (big picture): это инсталлятор/оператор конфигурации для Windows (и есть скрипт для Debian). Процесс: скачать ZIP с FTP, распаковать в `C:\Windows\_winbuff`, скопировать вспомогательные компоненты в `C:\Admins\add`, установить/проверить 7-Zip, создать задачу в Планировщике, править реестр и ExecutionPolicy, затем запустить `loging.ps1` из временной папки.

- Ключевые окружения и требования:
  - Windows с привилегиями администратора обязательно для большинства сценариев.
  - Python-скрипт использует кодировку CP1251 (см. заголовок в `winbuff.py`): соблюдай кодировку при редактировании.
  - Python зависимости: `requests` (для загрузки), стандартные модули (`ftplib`, `zipfile`, `subprocess`, `winreg`). Если изменяешь `winbuff.py`, убедись, что среда имеет `requests`.
  - Вызовы внешних утилит: `robocopy`, `schtasks`, `reg`, `powershell.exe` — все предполагают Windows CLI/PowerShell.

- Полезные места в коде (примеры):
  - `winbuff.py`: FTP-скачивание и распаковка, `robocopy` и проверка returncode (фрагмент: `if result.returncode > 3: raise ...` — учти особенность кодов `robocopy`).
  - `_winbuff.ps1`: зеркальная логика для PowerShell (загрузка FTP, expand-archive, schtasks, reg add). Изменения часто нужно применять в обоих файлах.
  - `winbuff.sh`: аналог для Debian (только для Linux-окружений) — полезно, если задача требует unix-ветки.

- Паттерны и проектные условности:
  - Жёстко закодированные пути: целевая директория `C:\Windows\_winbuff`, логи — `C:\Windows\_winbuff\log`, temp — `C:\Windows\_winbuff\temp`, админ-пакеты — `C:\Admins\add`.
  - 7-Zip: проект ожидает конкретный формат имени установщика (`7z2409-x64.exe` / `7z2409.exe`) и проверяет версию в выводе `7z.exe`.
  - Кодировка CP1251 в `winbuff.py` — сохраняй при изменениях; не меняй на UTF-8 без явной необходимости и тестирования.
  - Робастная проверка `robocopy`: учитывай не-тривиальные коды завершения (см. проверку `> 3`).

- Интеграции и внешние зависимости (важно для изменений):
  - FTP-сервер: `winbuff.evrasia.spb.ru` (учётные данные видны в коде). Обращай внимание на безопасность — не коммить изменения с учётными данными.
  - 7-Zip (установка через скачивание и silent install `/S`).
  - Планировщик задач Windows (`schtasks`), реестр (`reg`), `netfirewallrule` в PowerShell.

- Как тестировать и отлаживать изменения локально:
  - Проверяй в Windows VM с правами администратора.
  - Быстрый запуск Python (в PowerShell с правами admin):

```powershell
# в каталоге репозитория
python .\winbuff.py
```

  - Или запусти PowerShell-скрипт (как админ):

```powershell
Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
powershell -ExecutionPolicy Bypass -File .\_winbuff.ps1
```

  - Логи и артефакты: проверяй `C:\Windows\_winbuff\log` и `C:\Windows\_winbuff\temp`.

- Важные замечания по безопасности и PR-политике:
  - В репозитории есть явные FTP-учётные данные в `winbuff.py` и PowerShell — не публикуй их и не перемещай в другие файлы без согласования. Предпочтительно: выделять секреты в внешний конфиг/секретный стор (задача улучшения).
  - При правке команд, изменяющих реестр или ExecutionPolicy, добавляй ясную мотивацию в PR и тестовый план, требующий VM-валидации.

- Правила изменения кода (короткие рекомендации):
  - Синхронизируй изменения между `winbuff.py` и `_winbuff.ps1`, если они касаются однотипного поведения (скачивание, пути, имена файлов).
  - Не ломай кодировку CP1251 в `winbuff.py`.
  - При изменениях, влияющих на установку 7-Zip — проверяй именование инсталлятора и silent-режим установки.
  - При изменениях, влияющих на `robocopy`, учитывай проверку returncode >3 и документируй причину изменения.

Если что-то не покрыто или нужно больше контекста (например, доступы к FTP/тестовой машине, целевые версии Windows), скажите — добавлю раздел "Как тестировать" или развернутое руководство для PR. 

---
Файл создан автоматически — попросите меня уточнить любой пункт или дополнить примерами коммитов/PR-шаблоном.
